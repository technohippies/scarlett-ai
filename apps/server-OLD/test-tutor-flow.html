<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Tutor Flow</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #7c3aed;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
        }
        .error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }
        .success {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }
        pre {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .dot {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #8b5cf6;
            margin: 20px auto;
            transition: all 0.3s ease;
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.6);
        }
        .dot.speaking {
            animation: pulse 0.6s ease-in-out infinite;
        }
        .dot.processing {
            background: #f59e0b;
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.6);
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.8; }
        }
    </style>
</head>
<body>
    <h1>üé§ Test AI Tutor Flow</h1>

    <div class="section">
        <h2>Performance Data</h2>
        <pre id="performanceData">{
  "overallScore": 77,
  "grade": "B+",
  "songTitle": "Stronger",
  "artistName": "Kanye West",
  "lineResults": [
    {
      "expected": "Work it, make it, do it, makes us",
      "spoken": "Work could make it",
      "score": 44
    },
    {
      "expected": "Harder, better, faster, stronger",
      "spoken": "It makes us harder, better, faster, stronger. Nat, Nat, Nat",
      "score": 82
    },
    {
      "expected": "More than hour, our, never",
      "spoken": "More than hour never",
      "score": 65
    }
  ]
}</pre>
    </div>

    <div class="section">
        <h2>AI Tutor Demo</h2>
        <div class="dot" id="tutorDot"></div>
        <button id="testButton" onclick="testTutorFlow()">Test Complete Flow</button>
        <div id="status"></div>
    </div>

    <div class="section">
        <h2>Results</h2>
        <div id="feedbackResult"></div>
        <audio id="audioPlayer" controls style="width: 100%; margin-top: 10px; display: none;"></audio>
    </div>

    <script>
        const API_URL = 'https://scarlett-api.deletion-backup782.workers.dev';
        // const API_URL = 'http://localhost:8787';

        async function testTutorFlow() {
            const button = document.getElementById('testButton');
            const status = document.getElementById('status');
            const dot = document.getElementById('tutorDot');
            const feedbackDiv = document.getElementById('feedbackResult');
            const audio = document.getElementById('audioPlayer');
            
            button.disabled = true;
            dot.classList.add('processing');
            status.innerHTML = '<div class="status">üîÑ Calling AI tutor analysis...</div>';

            try {
                // Step 1: Get AI feedback
                const performanceData = JSON.parse(document.getElementById('performanceData').textContent);
                
                const analysisResponse = await fetch(`${API_URL}/api/tutor/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(performanceData)
                });

                if (!analysisResponse.ok) {
                    throw new Error(`Analysis failed: ${analysisResponse.status}`);
                }

                const { feedback } = await analysisResponse.json();
                
                feedbackDiv.innerHTML = `
                    <h3>AI Feedback:</h3>
                    <p><strong>Message:</strong> ${feedback.message}</p>
                    <p><strong>Focus Area:</strong> ${feedback.focusArea}</p>
                    <p><strong>Difficulty:</strong> ${feedback.difficulty}</p>
                `;

                status.innerHTML = '<div class="status">üéØ Generating TTS audio...</div>';

                // Step 2: Generate TTS
                const ttsResponse = await fetch(`${API_URL}/api/tutor/tts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: feedback.message,
                        voice: 'Rachel',
                        model: 'eleven_turbo_v2.5'
                    })
                });

                if (!ttsResponse.ok) {
                    throw new Error(`TTS failed: ${ttsResponse.status}`);
                }

                // Step 3: Play audio
                const audioBlob = await ttsResponse.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                
                audio.src = audioUrl;
                audio.style.display = 'block';
                
                dot.classList.remove('processing');
                dot.classList.add('speaking');
                
                status.innerHTML = '<div class="status success">‚úÖ Playing AI tutor feedback!</div>';
                
                audio.onplay = () => {
                    console.log('Audio started playing');
                };
                
                audio.onended = () => {
                    console.log('Audio finished');
                    dot.classList.remove('speaking');
                    button.disabled = false;
                };
                
                await audio.play();

            } catch (error) {
                console.error('Error:', error);
                status.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
                dot.classList.remove('processing', 'speaking');
                button.disabled = false;
            }
        }
    </script>
</body>
</html>